@model List<HizliOgren.Models.User>
@{
  ViewData["Title"] = "KullanÄ±cÄ± YÃ¶netimi";
  var purchaseCounts = ViewBag.PurchaseCounts as Dictionary<int, int>;
  var q = ViewBag.Q as string;
  var role = ViewBag.Role as string;
}
@if (TempData["Message"] != null)
{
  <p class="alert alert-success" style="margin-bottom: 16px;">@TempData["Message"]</p>
}
<form method="get" asp-action="Index" style="margin-bottom: 24px;">
  <input type="search" name="q" class="form-control" placeholder="E-posta veya ad ile ara..." value="@q" style="max-width: 320px; display: inline-block;" />
  <select name="role" class="form-control" style="max-width: 180px; display: inline-block;">
    <option value="">Rol: TÃ¼mÃ¼</option>
    <option value="0" selected="@(role == "0")">Ãœye</option>
    <option value="1" selected="@(role == "1")">EÄŸitmen</option>
    <option value="2" selected="@(role == "2")">Admin</option>
  </select>
  <button type="submit" class="btn btn-ghost">Filtrele</button>
</form>
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Ad Soyad</th>
        <th>E-posta</th>
        <th>Åifre</th>
        <th>Rol</th>
        <th>SatÄ±n AlÄ±nan</th>
        <th>KayÄ±t Tarihi</th>
        <th>Ä°ÅŸlem</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var u in Model)
      {
        var count = purchaseCounts != null && purchaseCounts.TryGetValue(u.Id, out var n) ? n : 0;
        <tr>
          <td>@u.FullName</td>
          <td>@u.Email</td>
          <td class="pwd-cell" style="white-space: nowrap;">
            <span class="pwd-mask" data-pwd="@(u.PlainPassword ?? "")" data-visible="0" title="GÃ¶rmek iÃ§in gÃ¶z ikonuna tÄ±klayÄ±n">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
            <button type="button" style="padding:3px 6px;" class="btn-pwd-toggle" aria-label="Åifreyi gÃ¶ster" title="Åifreyi gÃ¶ster">ğŸ‘</button>
          </td>
          <td>@u.Role.ToString()</td>
          <td><span class="badge badge-primary">@count eÄŸitim</span></td>
          <td>@u.CreatedAt.ToString("d MMM yyyy")</td>
          <td>
            <a asp-action="Edit" asp-route-id="@u.Id" class="btn btn-ghost btn-sm">DÃ¼zenle</a>
            <form method="post" asp-action="ChangeRole" asp-route-id="@u.Id" style="display: inline-flex; gap: 6px; align-items: center;">
              @Html.AntiForgeryToken()
              <select name="role" class="form-control" style="width: auto; min-width: 100px;">
                <option value="0" selected="@(u.Role == HizliOgren.Models.UserRole.Uye)">Ãœye</option>
                <option value="1" selected="@(u.Role == HizliOgren.Models.UserRole.Egitmen)">EÄŸitmen</option>
                <option value="2" selected="@(u.Role == HizliOgren.Models.UserRole.Admin)">Admin</option>
              </select>
              <button type="submit" class="btn btn-ghost btn-sm">Rol GÃ¼ncelle</button>
            </form>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>
@if (Model.Count == 0) { <p style="color: var(--text-muted);">KullanÄ±cÄ± bulunamadÄ±.</p> }

@section Scripts {
  <script>
    document.querySelectorAll('.pwd-cell').forEach(function(cell) {
      var mask = cell.querySelector('.pwd-mask');
      var btn = cell.querySelector('.btn-pwd-toggle');
      var pwd = mask.getAttribute('data-pwd') || '';
      function showPwd() {
        mask.textContent = pwd || '(yok)';
        mask.dataset.visible = '1';
        btn.style.display = 'none';
        mask.style.cursor = 'pointer';
        mask.title = 'Gizlemek iÃ§in tÄ±klayÄ±n';
      }
      function hidePwd() {
        mask.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        mask.dataset.visible = '0';
        btn.style.display = '';
        mask.style.cursor = '';
        mask.title = 'GÃ¶rmek iÃ§in gÃ¶z ikonuna tÄ±klayÄ±n';
      }
      btn.addEventListener('click', function() {
        showPwd();
      });
      mask.addEventListener('click', function() {
        if (mask.dataset.visible === '1') hidePwd();
      });
    });
  </script>
}
