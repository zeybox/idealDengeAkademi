@model List<HizliOgren.Models.User>
@{
  ViewData["Title"] = "Kullanƒ±cƒ± Y√∂netimi";
  var purchaseCounts = ViewBag.PurchaseCounts as Dictionary<int, int>;
  var q = ViewBag.Q as string;
  var role = ViewBag.Role as string;
}
@if (TempData["Message"] != null)
{
  <p class="alert alert-success" style="margin-bottom: 16px;">@TempData["Message"]</p>
}
<p style="margin-bottom: 16px;">
  <a asp-action="Create" class="btn btn-primary">+ Yeni kullanƒ±cƒ± ekle</a>
</p>
<form method="get" asp-action="Index" style="margin-bottom: 24px;">
  <input type="search" name="q" class="form-control" placeholder="E-posta veya ad ile ara..." value="@q" style="max-width: 320px; display: inline-block;" />
  <select name="role" class="form-control" style="max-width: 180px; display: inline-block;">
    <option value="">Rol: T√ºm√º</option>
    <option value="0" selected="@(role == "0")">√úye</option>
    <option value="1" selected="@(role == "1")">Eƒüitmen</option>
    <option value="2" selected="@(role == "2")">Admin</option>
  </select>
  <button type="submit" class="btn btn-ghost">Filtrele</button>
</form>
<div class="table-wrap">
  <table class="users-table-sortable">
    <thead>
      <tr>
        <th style="width: 52px;"></th>
        <th class="sortable" data-sort-key="fullname" scope="col"><span class="th-label">Ad Soyad</span><span class="sort-indicator" aria-hidden="true"></span></th>
        <th class="sortable" data-sort-key="email" scope="col"><span class="th-label">E-posta</span><span class="sort-indicator" aria-hidden="true"></span></th>
        <th>≈ûifre</th>
        <th class="sortable" data-sort-key="role" scope="col"><span class="th-label">Rol</span><span class="sort-indicator" aria-hidden="true"></span></th>
        <th>Satƒ±n Alƒ±nan</th>
        <th class="sortable" data-sort-key="date" scope="col"><span class="th-label">Kayƒ±t Tarihi</span><span class="sort-indicator" aria-hidden="true"></span></th>
        <th>ƒ∞≈ülem</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var u in Model)
      {
        var count = purchaseCounts != null && purchaseCounts.TryGetValue(u.Id, out var n) ? n : 0;
        var avatarUrl = !string.IsNullOrEmpty(u.AvatarUrl) ? u.AvatarUrl : "";
        <tr data-sort-fullname="@(u.FullName ?? "")" data-sort-email="@(u.Email ?? "")" data-sort-role="@u.Role.ToString()" data-sort-date="@u.CreatedAt.ToString("o")">
          <td style="vertical-align: middle;">
            <img src="@(string.IsNullOrEmpty(avatarUrl) ? "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" : avatarUrl)" alt="" class="user-list-avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: block; background: var(--bg-soft);" />
          </td>
          <td>@u.FullName</td>
          <td>@u.Email</td>
          <td class="pwd-cell" style="white-space: nowrap;">
            <span class="pwd-mask" data-pwd="@(u.PlainPassword ?? "")" data-visible="0" title="G√∂rmek i√ßin g√∂z ikonuna tƒ±klayƒ±n">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button type="button" style="padding:3px 6px;" class="btn-pwd-toggle" aria-label="≈ûifreyi g√∂ster" title="≈ûifreyi g√∂ster">üëÅ</button>
          </td>
          <td>@u.Role.ToString()</td>
          <td>
          <span class="badge badge-primary">@count eƒüitim</span>
          <a asp-action="EditCourses" asp-route-id="@u.Id" class="btn btn-ghost btn-sm">Eƒüitimleri d√ºzenle</a>
          </td>
          <td>@u.CreatedAt.ToString("d MMM yyyy")</td>
          <td>
            <a asp-action="Edit" asp-route-id="@u.Id" class="btn btn-ghost btn-sm">D√ºzenle</a>
            <button type="button" class="btn btn-ghost btn-sm" data-confirm-delete
              data-delete-action="@Url.Action("Delete", "Users", new { area = "Admin", id = u.Id })"
              data-delete-message="@(u.FullName) kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz."
              data-delete-button-text="Evet, sil">Sil</button>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>
@if (Model.Count == 0) { <p style="color: var(--text-muted);">Kullanƒ±cƒ± bulunamadƒ±.</p> }

@section Scripts {
  <script>
    (function() {
      var table = document.querySelector('.users-table-sortable');
      if (!table) return;
      var tbody = table.querySelector('tbody');
      var headers = table.querySelectorAll('thead th.sortable');
      var currentKey = null;
      var currentDir = 1;

      function clearIndicators() {
        headers.forEach(function(th) {
          var ind = th.querySelector('.sort-indicator');
          if (ind) { ind.textContent = ''; ind.className = 'sort-indicator'; }
        });
      }
      function setIndicator(th, dir) {
        var ind = th.querySelector('.sort-indicator');
        if (ind) {
          ind.textContent = dir === 1 ? '\u25b2' : '\u25bc';
          ind.className = 'sort-indicator sort-' + (dir === 1 ? 'asc' : 'desc');
        }
      }
      function sort(key) {
        var dir = (currentKey === key) ? -currentDir : 1;
        currentKey = key;
        currentDir = dir;
        clearIndicators();
        var activeTh = Array.prototype.find.call(headers, function(th) { return th.getAttribute('data-sort-key') === key; });
        if (activeTh) setIndicator(activeTh, dir);

        var rows = Array.prototype.slice.call(tbody.querySelectorAll('tr'));
        var attr = 'data-sort-' + key;
        rows.sort(function(a, b) {
          var va = a.getAttribute(attr) || '';
          var vb = b.getAttribute(attr) || '';
          if (key === 'date') {
            var da = new Date(va).getTime();
            var db = new Date(vb).getTime();
            return dir * (da - db);
          }
          var c = (va + '').localeCompare(vb + '', 'tr');
          return dir * (c || 0);
        });
        rows.forEach(function(r) { tbody.appendChild(r); });
      }

      headers.forEach(function(th) {
        th.style.cursor = 'pointer';
        th.setAttribute('title', 'Sƒ±ralamak i√ßin tƒ±klayƒ±n');
        th.addEventListener('click', function() {
          var key = th.getAttribute('data-sort-key');
          if (key) sort(key);
        });
      });
    })();
  </script>
  <script>
    document.querySelectorAll('.pwd-cell').forEach(function(cell) {
      var mask = cell.querySelector('.pwd-mask');
      var btn = cell.querySelector('.btn-pwd-toggle');
      var pwd = mask.getAttribute('data-pwd') || '';
      function showPwd() {
        mask.textContent = pwd || '(yok)';
        mask.dataset.visible = '1';
        btn.style.display = 'none';
        mask.style.cursor = 'pointer';
        mask.title = 'Gizlemek i√ßin tƒ±klayƒ±n';
      }
      function hidePwd() {
        mask.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        mask.dataset.visible = '0';
        btn.style.display = '';
        mask.style.cursor = '';
        mask.title = 'G√∂rmek i√ßin g√∂z ikonuna tƒ±klayƒ±n';
      }
      btn.addEventListener('click', function() {
        showPwd();
      });
      mask.addEventListener('click', function() {
        if (mask.dataset.visible === '1') hidePwd();
      });
    });
  </script>
}
